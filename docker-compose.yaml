name: hypernode-server

services:
  messageBroker:
    image: rabbitmq:3.8.17-management
    ports:
      - "5672:5672"
     # - "15672:15672"
    networks:
      - hypernode-net
    environment:
      RABBITMQ_DEFAULT_USER: hypernode
      RABBITMQ_DEFAULT_PASS: hypernode
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    container_name: messageBroker
    restart: unless-stopped
    
  database:
    image: mongo:4.4
    ports:
      - 27050:27017
    networks:
      - hypernode-net
    volumes:
      - mongodb_data:/data/db
    container_name: database
    restart: unless-stopped

  gateway:
      build:
        context: ../hypernode-server
        dockerfile: ../hypernode-server/docker/gateway.Dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
        args:
          SERVICE_NAME: "gateway-service"  # Replace with the desired service name
      # ports:
      #   - "8000:8000"
      #   - "5001:5001"
      #   #debugging port
      #   - 9229:9229
      networks:
        - hypernode-net

      environment:
        - GATEWAY_API_PORT=5001
        - GATEWAY_WS_PORT=8000
        - RABBITMQ_URI=${RMQ:-amqp://hypernode:hypernode@messageBroker:5672}
        - DATABASE_URI=mongodb://database:27017/gateway-db
      container_name: gateway
      restart: unless-stopped

  storage:
    build:
      context: ../hypernode-server/
      dockerfile: ../hypernode-server/docker/storage.Dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
      args:
        SERVICE_NAME: "storage-service"  # Replace with the desired service name
    networks:
       - hypernode-net
    environment:
      - RABBITMQ_URI=${RMQ:-amqp://hypernode:hypernode@messageBroker:5672}
      - DATABASE_URI=mongodb://database:27017/storage-db
    container_name: storage
    restart: unless-stopped

  event:
    build:
      context: ../hypernode-server/
      dockerfile: ../hypernode-server/docker/event.Dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
      args:
        SERVICE_NAME: "event-service"  # Replace with the desired service name
    networks:
       - hypernode-net
    environment:
      - RABBITMQ_URI=${RMQ:-amqp://hypernode:hypernode@messageBroker:5672}
      - DATABASE_URI=mongodb://database:27017/event-db
    container_name: event
    restart: unless-stopped

  camera:
    build:
      context: ../hypernode-server/
      dockerfile: ../hypernode-server/docker/camera.Dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
      args:
        SERVICE_NAME: "camera-service"  # Replace with the desired service name  
    networks:
       - hypernode-net
    environment:
      - RABBITMQ_URI=${RMQ:-amqp://hypernode:hypernode@messageBroker:5672}
      - DATABASE_URI=mongodb://database:27017/camera-db
    container_name: camera
    restart: unless-stopped

  # deploy:
  #   resources:
  #     limits:
  #       memory: 1G  # Limita a un massimo di 1 GB di RAM
  #       cpus: '1.5'  # Limita a un massimo di 1.5 CPU
  #     reservations:
  #       memory: 512M  # Riserva almeno 512 MB di RAM
  #       cpus: '0.5'  # Riserva almeno 0.5 CPU

  auth:
    build:
      context: ../hypernode-server/
      dockerfile: ../hypernode-server/docker/auth.Dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
      args:
        SERVICE_NAME: "auth-service"  # Replace with the desired service name
    networks:
       - hypernode-net
    environment:
      - RABBITMQ_URI=${RMQ:-amqp://hypernode:hypernode@messageBroker:5672}
      - DATABASE_URI=mongodb://database:27017/auth-db
    container_name: auth
    restart: unless-stopped

  webserver:
    build:
      context: .
      dockerfile: nginx.prod.dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
    ports:
        - "${SERVER_PORT:-80}:80"
        - "${SSL_PORT:-443}:443"
    container_name: webserver
    networks:
       - hypernode-net
    restart: unless-stopped

  configurator:
    build:
      context: ../hypernode_server_gui
      dockerfile: ../hypernode_server_gui/dockerfile  # or specify the path to your Dockerfile if it's not in the same directory
    container_name: configurator
    networks:
      - hypernode-net
    ports:
      - "${CONF_PORT:-8080}:8080"
    restart: unless-stopped

    
volumes:
  rabbitmq_data:
  mongodb_data:
   
networks:
  hypernode-net:
      driver: bridge


#USAGE
# SERVER_PORT=80 SSL_PORT=443 RMQ=amqp://hypernode:hypernode@messageBroker:5672  docker compose up -d

#sudo docker compose build camera-service && sudo docker compose up -d camera-service

#sudo docker compose up -d camera-service
